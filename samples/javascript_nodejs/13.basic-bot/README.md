This sample shows how to create a bot that uses Language Understanding (LUIS), implement a multi-turn conversation using Dialogs, handle user interruptions for such things as Help or Cancel, prompt for and validate requests for information from the user.

# Table of Contents

- [Concepts introduced in this sample](#concepts-introduced-in-this-sample)
  * [Handle user interruptions](#handle-user-interruptions)
- [To try this sample](#to-try-this-sample)
  * [Prerequisites](#prerequisites)
    + [Clone the repo](#clone-the-repo)
  * [Configure Services](#configure-services)
    + [Using CLI Tools](#using-cli-tools)
    + [[Alternate to CLI] Set up LUIS via Portal](#-alternate-to-cli--set-up-luis-via-portal)
  * [Run the Sample](#run-the-sample)
    + [Visual Studio Code](#visual-studio-code)
  * [Testing the bot using Bot Framework Emulator](#testing-the-bot-using-bot-framework-emulator)
    + [Connect to bot using Bot Framework Emulator **V4**](#connect-to-bot-using-bot-framework-emulator---v4--)
- [Further reading](#further-reading)

# Concepts introduced in this sample

## Handle user interruptions
Handling interruptions is an important aspect of a robust bot.

While you may think that your users will follow your defined conversation flow step by step, chances are good that they will change their minds or ask a question in the middle of the process instead of answering the question. In these situations, how would your bot handle the user's input? What would the user experience be like? How would you maintain user state data? Handling interruptions means making sure your bot is prepared to handle situations like this.

There is no right answer to these questions as each situation is unique to the scenario your bot is designed to handle. In this topic, we will explore some common ways to handle user interruptions and suggest some ways to implement them in your bot.

# To try this sample
## Prerequisites
### Clone the repo
To clone the repository:
```bash
git clone https://github.com/microsoft/botbuilder-samples.git
```

## Configure Services
### Using CLI Tools

1. Install the Bot CLI Tools
	```bash
	npm install -g chatdown msbot ludown luis-apis qnamaker botdispatch luisgen
   ```

2. Setup Azure Powershell (If you have never done so before)
    - To login, run:
        ```bash
        Connect-AzureRmAccount
        ```

    - To select your Azure subscription, run:
        ```bash
        Select-AzureRmSubscription -Subscription "subscription-name"
        ```

3. Collect your Luis Authoring Key from the the [LUIS portal](https://www.luis.ai) by selecting your name in the top right corner. Save this key for the next step.

4. Run the following command from the project directory:
	```bash
	msbot clone services --name "<NAME>" --luisAuthoringKey "<YOUR AUTHORING KEY>" --folder "DeploymentScripts/MsbotClone" --location "westus" --verbose
	```
**NOTE**: By default your Luis Applications will be deployed to your free starter endpoint. An Azure LUIS service will be deployed along with your bot but you must manually add and publish to it from the luis.ai portal and update your key in the `.bot` file.

5. Note the generated secret generated by msbot. 
- The secret key is used later for `appsettings.json`.
    ```bash
    The secret used to decrypt <NAME>.bot is:
    XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX=
    NOTE: This secret is not recoverable and you should store this secret in a secure place according to best security practices.
    Your project may be configured to rely on this secret and you should update it as appropriate.
    ```
5. Inspect Bot configuration file.
- The `msbot clone` command above generates a bot configuration file.
- The name of the bot configuration file is `<NAME>.bot`, where <NAME> is the name of your bot used in the `msbot clone` step.
- The configuration file can be loaded by the [Microsoft Bot Framework Emulator](https://aka.ms/botframeworkemulator).

6. Update `<YOUR BOT CONFIGURATION>` in `Startup.cs`.
    ```c#
    public void ConfigureServices(IServiceCollection services)
    {
        ...
        var botConfig = BotConfiguration.Load(botFilePath ??  @".\<YOUR BOT CONFIGURATION>.bot"..);
        ...
    }
    ```

  7. Update `<YOUR_BOT_NAME>` in `BasicBot.cs`.

	```csharp
	public class BasicBot : IBot
	{
		...
		public static readonly string LuisConfiguration = <YOUR_BOT_NAME> +  "basic-bot-LUIS";
		...
	}
	```
  8. Right click on the generated bot configuration file, click "*Properties*".
  - Ensure "*Copy to Output Directory*" is set to "*Copy always*".


  9. Update your `appsettings.json` with your .bot file path and .bot file secret.
- Update the `botFilePath` with the name of your generated bot configuration file.
- Update the `botFileSecret` with the secret that the msbot tool generated from step 5 above.

	```javascript
	{
		"botFilePath": "<YOUR BOT CONFIG>.bot",
		"botFileSecret": "<YOUR BOT SECRET>"
	}
	```

### [Alternate to CLI] Set up LUIS via Portal
- Navigate to [LUIS portal](https://www.luis.ai).
- Click the `Sign in` button.
- Click on the `Choose File` and select [basic-bot.json](basic-bot.json) from the `botbuilder-samples/javascript_nodejs/13.basic-bot/CognitiveModels` folder.
- Update [BotConfiguration.bot](BotConfiguration.bot) file with your AppId, SubscriptionKey, Region and Version. 
    You can find this information under "*Manage*" tab for your LUIS application at [LUIS portal](https://www.luis.ai).
    - The `AppID` can be found in "*Application Information*"
    - The `SubscriptionKey` can be found in "*Keys and Endpoints*", under the `Key 1` column
    - The `region` can be found in "*Keys and Endpoints*", under the `Region` column
- Update [BotConfiguration.bot](BotConfiguration.bot) file with your Authoring Key.  
    You can find this under your user settings at [luis.ai](https://www.luis.ai).  Click on your name in the upper right hand corner of the portal, and click on the "*Settings*" menu option.
    **NOTE**: Once you publish your app on LUIS portal for the first time, it takes some time for the endpoint to become available, about 5 minutes of wait should be sufficient.
- Update [BotConfiguration.bot](BotConfiguration.bot) file to ensure the `Id` property on the `luis` service type is set to `basic-bot-LUIS`.

## Run the Sample
### Visual Studio Code
- In a terminal, navigate to the following directory:
	```bash
	cd samples\javascript_nodejs\13.basic-bot
	```

	**Optional:** Update the `.env` file under `samples\javascript_nodejs\13.basic-bot` with your **botFileSecret**.
	For Azure Bot Service bots, you can find the botFileSecret under application settings.

- Install modules and start the bot:
	```bash
	npm i && npm start
	```
Alternatively you can also use nodemon via:
	```bash
	npm i && npm run watch
	```

## Testing the bot using Bot Framework Emulator

[Microsoft Bot Framework Emulator](https://github.com/microsoft/botframework-emulator) is a desktop application that allows bot developers to test and debug their bots on localhost or running remotely through a tunnel.

Install the Bot Framework emulator from [here](https://github.com/Microsoft/BotFramework-Emulator/releases).

### Connect to bot using Bot Framework Emulator **V4**
- Launch Bot Framework Emulator
- From the *File* menu select *Open Bot Configuration*
- Navigate to your `.bot` file

# Further reading
- [Bot Framework Documentation](https://docs.botframework.com)
- [Bot basics](https://docs.microsoft.com/en-us/azure/bot-service/bot-builder-basics?view=azure-bot-service-4.0)
- [Handle user interruptions](https://docs.microsoft.com/en-us/azure/bot-service/bot-builder-howto-handle-user-interrupt?view=azure-bot-service-4.0&tabs=jstab)
- [Activity processing](https://docs.microsoft.com/en-us/azure/bot-service/bot-builder-concept-activity-processing?view=azure-bot-service-4.0)
- [LUIS](https://www.luis.ai)
- [Prompt Types](https://docs.microsoft.com/en-us/azure/bot-service/bot-builder-prompts?view=azure-bot-service-4.0&tabs=javascript)
- [Azure Bot Service Introduction](https://docs.microsoft.com/en-us/azure/bot-service/bot-service-overview-introduction?view=azure-bot-service-4.0)
- [Channels and Bot Connector Service](https://docs.microsoft.com/en-us/azure/bot-service/bot-concepts?view=azure-bot-service-4.0)
- [QnA Maker](https://qnamaker.ai)